

```{r initCST_CLR, message=F, echo=F, echo=FALSE}
library("phyloseq")
library("ggplot2")
library("cluster")
library("igraph")
library("markovchain")
library("RColorBrewer")
library(microbiome)
library("gridExtra")
library(tidyr)
library(dplyr)
set.seed(455423)
default.par <- par(no.readonly = TRUE)
options(stringsAsFactors = FALSE)
theme_set(theme_bw())
# EXCLUDEMARGINAL is a flag to exclude marginally preterm births (=37 weeks) in the later analysis
#EXCLUDEMARGINAL = TRUE
```
# Transform the data (proportions)
```{r transform-data_CLRleo, message=FALSE, echo=FALSE, warning=FALSE}
#site <- "Vaginal_Swab"
ps <- readRDS("data/processed/phyloseq/phy20.1.RDS")
tt <- data.frame(tax_table(ps))
ps <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps1<- prune_taxa(names(sort(taxa_sums(ps), T))[1:50], ps)
taxa.order1<- taxa_names(ps1)
```

# Cluster into CSTs
```{r MDS_CLRleo, warning=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
braydist <- phyloseq::distance(ps, method="bray")
ord = ordinate(ps, method = "MDS", distance = braydist)
plot_scree(ord) + xlim(as.character(seq(1,15))) + ggtitle("MDS-bray ordination eigenvalues")
evs <- ord$value$Eigenvalues
print(evs[1:20])
print(tail(evs))
```

## Denoise distance matrix
```{r PCoA-cutoff2_CLRleo, warning=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
h_sub5 <- hist(evs[6:length(evs)], 100)
plot(h_sub5$mids, h_sub5$count, log="y", type='h', lwd=10, lend=2)
```

## Determine number of clusters
We will use the gap statistic to indicate the number of clusters in this data:
```{r gap-stat_CLRleo, message=FALSE, echo=FALSE, warning=FALSE}
NDIM <- 7
x <- ord$vectors[,1:NDIM]  # rows=sample, cols=MDS axes, entries = value
pamPCoA = function(x, k) {
  list(cluster = pam(x[,1:2], k, cluster.only = TRUE))
}
gs = clusGap(x, FUN = pamPCoA, K.max = 12, B = 50)
plot_clusgap(gs) + scale_x_continuous(breaks=c(seq(0, 12, 2)))
```

## Cluster into CSTs

Perform PAM 3-fold clusters:

```{r pam-k5_CLRleo, message=FALSE, echo=FALSE, warning=FALSE}
K <- 3
x <- ord$vectors[,1:NDIM]
clust <- as.factor(pam(x, k=K, cluster.only=T))

# SWAPPING THE ASSIGNMENT OF 2 AND 3 TO MATCH RAVEL CST ENUMERATION
clust[clust==2] <- NA
clust[clust==3] <- 2
clust[is.na(clust)] <- 3
sample_data(ps)$CST <- clust
CSTs <- as.character(seq(K))
```

## Evaluate clustering
```{r see-pam-k3_CLRleo,eval=T,results = 'hide',  message=FALSE, echo=FALSE, warning=FALSE}
CSTColors <- brewer.pal(6,"Paired")[c(1,3,2,5,4,6)] # Length 6 for consistency with pre-revision CST+ coloration
names(CSTColors) <- CSTs
CSTColorScale <- scale_colour_manual(name = "CST", values = CSTColors[1:5])
CSTFillScale <- scale_fill_manual(name = "CST", values = CSTColors[1:5])
#grid.arrange(phyloseq::plot_ordination(ps, ord, color="CST") + CSTColorScale,plot_ordination(ps, ord, axes=c(3,4), color="CST") + CSTColorScale, main="Ordination by Cluster")
ok<-ordinate(ps, method="NMDS", distance=braydist)
knitr::opts_chunk$set(results = "hide")
```
```{r see-pam-k5u_CLRleo, message=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
plot_ordination(ps,ok , color="CST") + CSTColorScale + ggtitle("NMDS -- bray -- By Cluster")
```





```{r see-pam-k3Sampesl_CLRleo, message=FALSE,, results="hide",  message=FALSE, echo=FALSE, warning=FALSE}
o<- ordinate(ps, method="NMDS", distance=braydist)
knitr::opts_chunk$set(results = "hide")
```

```{r see-pam-k3Sampesl55_CLRleo, message=FALSE, message=FALSE, echo=FALSE, warning=FALSE, fig.height=8, fig.width=12, out.width='50%', fig.show="hold"}
theme_set(theme_bw(base_size = 20))
plot_ordination(ps,o , "samples", color="Diet", shape = 'Veg') + geom_point(size=2)+ xlim(-1, 1)+ ylim(-.5, .5)
par(mfrow=c(1,4), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
```

# Principal Coordinates Analysis (PCoA)

Coloured by DMM community type

```{r pcoa, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="33%", fig.show="hold", warning=FALSE}
method <- "PCoA"
trans <- "compositional"
distance <- "bray"
p <- plot_landscape(microbiome::transform(ps , "compositional"),
                    distance = distance,
                    method = method,
                    size = 3,
                    col = "CST",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p)
```

### Heatmap

Heatmaps for the community state types.

```{r clust-diverse_CLRleo, eval= T, message=FALSE, echo=FALSE, warning=FALSE, out.width="33%", fig.show="hold", warning=FALSE}
theme_set(theme_bw(base_size = 20))
library(BBmisc)
library(reshape2)
library("RColorBrewer")
library(tidyr)
set.seed(1234)

# Identify ASVs that are potentially different between CSTs
pvs <- c()
for (tax in taxa(ps)) {
  pvs[[tax]] <- kruskal.test(abundances(ps)[tax,] ~ meta(ps)$CST)$p.value
}
pvs <- sort(unlist(pvs))
significant.taxa <- names(pvs)[which(as.numeric(p.adjust(pvs)) < 0.25)]

# Pick full names for the taxa
full.names <- apply(tax_table(ps), 1, function (x) {paste(x, collapse = "_")})

pso<- prune_taxa(significant.taxa, ps)
pso1<- microbiome::transform(pso, 'clr')
g<- otu_table(pso1)
g1<-BBmisc::normalize(g@.Data, 'standardize', range = c(0,1))
colnames(g1)<- colnames(otu_table(pso1)@.Data)
j<- otu_table(g1, taxa_are_rows = T)
otu_table(pso1)<- j
p <- list()
sort.taxa <- neatsort(pso1, "rows")
for(CST in CSTs) {
  pshm <- prune_samples(sample_data(pso1)$CST == CST, pso1)
  dfm <- melt(abundances(pshm))
  colnames(dfm) <- c("Taxa", "Sample", "value")
  dfm$Taxa <- factor(dfm$Taxa, levels = sort.taxa)
  dfm$Sample <- factor(dfm$Sample, levels = neatsort(pshm, "cols"))
  p[[CST]]<- heat((dfm), "Sample","Taxa", "value", legend.text = "Abundance", order.rows = F, 
                order.cols = F, limits= c(-5,5), step = 0.5) +
		ggtitle(paste("CST:", CST))
print(p[[CST]])
}
```


### Boxplots for each genus in the three clusters

```{r clust-diverse_boxplot_CLRleo, message=FALSE, echo=FALSE, warning=FALSE, out.width="25%"}
theme_set(theme_bw(base_size = 20))
library(ggbeeswarm)
df<- meta(pso)

for (tax in rev(significant.taxa)) {

  # Pick the abundance values for the given taxonomic group ("tax")
  # Let us use compositional transformed values
  df$signal <- abundances(transform(pso, "compositional"))[tax,]

  # Retrieve the full name for this taxon
  tax.full.name <- full.names[tax]

  # Plot taxon abundance (signal) against the cluster (CST) as a boxplot
  p <- ggplot(df, aes(x = CST, y = signal)) +
         labs(title = tax) +
         geom_boxplot() +
	 geom_beeswarm() +
	 labs(y = "Relative abundance (%)") + 
	 scale_y_log10(labels = scales::percent)
  print(p)
  
}
```


Table of full names for the taxa:

```{r full_names}
tab <- data.frame(ASV = significant.taxa, Full_name = full.names[significant.taxa])
print(kable(tab))
```

