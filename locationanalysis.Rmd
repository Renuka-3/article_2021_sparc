---
title: "Location analysis"
author: "Renuka"
date: "`r Sys.Date()`"
output: html_document
---

# Analysis

```{r alpha, message=F, echo=F, echo=FALSE}
library(knitr)
library(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
library(microbiome)

theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
knitr::opts_chunk$set(fig.path="figure_location/")
opts_chunk$set(dev="CairoPNG")

# Was created with: source("create_phyloseq.R")
phy <- readRDS("data/processed/phyloseq/phy20.1.RDS")
```


# Alpha diversity analysis

```{r alpha1, echo=FALSE, message=FALSE, warning=FALSE}
# Estimate alpha diversities
A <- alpha(phy)
index <- "diversity_shannon"
```


# Group-wise comparisons

Diversity index: `r index`

```{r group_comp, echo=FALSE, echo=FALSE, message=FALSE, fig.width=10, fig.height=6, fig.show="keep", out.width="50%"}
library(Cairo)
df <- meta(phy)
df <- bind_cols(df, A)
df$index <- df[[index]]
pv <- kruskal.test(data = df, index ~ factor(Geographical_location))$p.value
library(ggbeeswarm)
p1 <- ggplot(df, aes(x = Geographical_location, y = index, fill = Geographical_location)) +
        ggbeeswarm::geom_beeswarm() +
	theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
        labs(y = "Shannon Diversity",
	     x = "",
	     title = paste0("Kruskal test p=", round(pv, 2)))

print(p1)
```

# Ordination

```{r init, echo=FALSE, message=FALSE}
library(microbiome)
library(phyloseq)
library(vegan)
opts_chunk$set(dev="CairoPNG")
method <- "PCoA"
trans <- "compositional"
distance <- "bray"
```

## Principal Coordinates Analysis (PCoA)

* Ordination method: `r method`
* Dissimilarity measure: `r distance`

```{r pcoa, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="50%", fig.show="hold"}
theme_set(theme_bw(15))
library(microbiome)
p <- plot_landscape(microbiome::transform(phy , "compositional"),
                    distance = distance,
                    method = method,
                    size = 3,
                    col = "Geographical_location",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p)
```



# Community composition (with PERMANOVA)

```{r PERMANOVA}
library(microbiome)
library(ggplot2)
library(dplyr)

pseq <- phy# Rename the example data
data = microbiome::meta(phy)
# Pick relative abundances (compositional) and sample metadata 
pseq.rel <- microbiome::transform(pseq, "compositional")
otu <- abundances(pseq.rel)
meta <- meta(pseq.rel)
library(vegan)
library(phyloseq)
permanova <- adonis(t(otu) ~ Geographical_location,
               data = meta(phy), permutations=99, method = distance)

# P-value
print(as.data.frame(permanova$aov.tab)["Geographical_location", "Pr(>F)"])

# Check beta dispersion - is this OK?
dist <- vegdist(t(otu))
anova(betadisper(dist, meta$Geographical_location))
```


# Investigate the top factors

```{r top_factors, fig.width=20, fig.height=10}
library(vegan)

coef1 <- coefficients(permanova)["Geographical_location1", ]
top.coef1 <- coef1[rev(order(abs(coef1)))[1:20]]
names(top.coef1) <- full.names[names(top.coef1)]

coef2 <- coefficients(permanova)["Geographical_location2", ]
top.coef2 <- coef2[rev(order(abs(coef2)))[1:20]]
names(top.coef2) <- full.names[names(top.coef2)]

par(mar = c(3, 20, 2, 1), mfrow = 2)
barplot(sort(top.coef1), horiz = T, las = 1, main = "Top taxa / 1")
barplot(sort(top.coef2), horiz = T, las = 1, main = "Top taxa / 2")
```



## Differential abundance analysis (with Kruskal-Wallis test)

Significant (or marginally signifiant) taxa between geographical locations.

```{r diffab, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="25%", fig.show="hold"}
location <- meta(phy)$Geographical_location
A <- abundances(phy);
pv <- apply(A, 1, function (x) {kruskal.test(x ~ location)$p.value});
padj <- p.adjust(pv);

df <- data.frame(taxon = names(padj), padj = padj)
# Add full names for the taxa
full.names <- apply(tax_table(phy), 1, function (x) {paste(x, collapse = "_")})
df$full_name <- full.names[df$taxon]
df <- df %>% filter(padj < 0.25) %>% arrange(padj)
rownames(df) <- NULL

library(knitr)
kable(df)

ps <- microbiome::transform(phy, "clr")
d <- meta(ps)
for (tax in df$taxon) {
  d$taxa <- abundances(ps)[tax, ]
  p <- ggplot(d, aes(x = Geographical_location, y = taxa)) +
    geom_boxplot() + 
    ggbeeswarm::geom_beeswarm() +
    theme(axis.text.x = element_text(angle = 360, hjust = 1)) +
    labs(x = "Location", y = "Abundance (CLR)", title = tax)
  print(p)
}
```



