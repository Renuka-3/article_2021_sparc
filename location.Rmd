
# Analysis

```{r, message=F, error=FALSE, echo=FALSE, warning=FALSE}
library(knitr)
library(knitcitations) 
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
library(microbiome)
library(microbiome)
library(phyloseq)
library(vegan)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
knitr::opts_chunk$set(fig.path="figure_location/")
opts_chunk$set(dev="CairoPNG")
# Was created with: source("create_phyloseq.R")
phy <- readRDS("data/processed/phyloseq/phy20.1.RDS")
method <- "PCoA"
trans <- "compositional"
distance <- "bray"
index <- "diversity_shannon"
```


## Alpha diversity analysis

Diversity index: `r index`

```{r alpha1, echo=FALSE, message=FALSE, warning=FALSE}
# Estimate alpha diversities
A <- alpha(phy)
b <- meta(phy)
b2 <- bind_cols(b,A)
is.data.frame(b) 
is.data.frame(b2)
z<- sapply(split(b2$diversity_shannon, b2$Geographical_location), mean)
f <- sapply(split(b2$diversity_shannon, b2$Geographical_location), sd) 
v <- cbind(z,f)
kable(v)
```


```{r diffab, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=6, fig.show="keep", out.width="50%"}
theme_set(theme_bw(base_size=25))
library(Cairo)
df <- meta(phy)
df <- bind_cols(df, A)
df$index <- df[[index]]
pv <- kruskal.test(data = df, index ~ factor(Geographical_location))$p.value
kruskal.test(data = df, index ~factor(Geographical_location))

library(ggbeeswarm)
library(ggsignif)
jpeg(file= "figure_location.jpeg", quality = 100)
p1 <- ggplot(df, aes(x = Geographical_location, y = index)) +
       geom_boxplot(color = "black") +
       geom_jitter(width = 0.1) +  
        theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + theme(legend.position = "none")+
        labs(y = "Shannon Diversity",
	     x = "",
	     title = "Geographical location")
  #geom_signif(comparisons = list(c("Ahmednagar", "Nashik", "Pune")),map_signif_level = TRUE) 
print(p1)
```  

## investigating top factors


```{r topfact, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.show="keep", out.width="50%"}
theme_set(theme_bw(base_size=25))
sp <- aggregate_taxa(phy, "genus")
core.taxa <- core_members(microbiome::transform(sp, "compositional"), detection = 0.1/100, prevalence=20/100) # FOcus on core taxa
#@#sp <- microbiome::transform(sp, "clr")
#@#sp.comp <- microbiome::transform(microbiome::transform(sp, "shift", shift=1), "compositional")

# Statistical testing done here at CLR abundances and filtering out rare taxa
#@#pvs <- sapply(core.taxa, function (i) {kruskal.test(abundances(sp)[i,] ~ meta(sp)[, "Geographical_location"])$p.value})
#@#padj <- p.adjust(pvs, method = "fdr")
#@#toptaxa <- names(which(padj < 0.05))
#names(pvs) <- gsub(names(pvs), pattern = "Propionibacterium", replacement = "Propionibacterium/Cutibacterium")

# Visualization done for compositional data for intuitive presentation
theme_set(theme_bw(20))

# Just pick the top taza for visu
df <- psmelt(prune_taxa(toptaxa, sp.comp))
df$Genus<- gsub((df$genus), pattern = "Propionibacterium", replacement = "Propionibacterium/Cutibacterium")
l <- ggplot(df, aes(x = Sample, fill = Genus, y = Abundance)) + geom_bar(stat = "identity", colour = "black") + facet_grid(Geographical_location ~ .)
print(l)
##p <- ggplot(df, aes(x = Genus, y = Abundance,
#       fill = Geographical_location))+
 #      labs(y = " Relative abundance (%)", x = '') +
  #     geom_boxplot() +
   #    coord_flip() +
       #scale_y_log10(label = scales::percent) +
   #    scale_y_continuous(label = scales::percent) +       
    #   labs(fill = " Geographical location")
###print(p)

# Making bar graph

#df <- df %>% arrange(df, Geographical_location) %>% mutate(Sample=factor(Sample, levels=unique(Sample)))

###M = ggplot(df, aes(x = Sample, fill = Genus, y = Abundance)) + 
#    geom_bar(stat = "identity", colour = "black") +
 #   theme(axis.text.x = element_text(angle = 90, size = 14, colour = "black", vjust = 0.5, hjust = 1, face= "bold"), #
 #         axis.title.y = element_text(size = 16, face = "bold"), legend.title = element_text(size = 16, face = "bold"), 
  #        legend.text = element_text(size = 12, face = "bold", colour = "black"), 
     #     axis.text.y = element_text(colour = "black", size = 12, face = "bold")) + 
   # scale_y_continuous(expand = c(0,0)) +
    #labs(x = "Sample", y = "Relative Abundance (%)")

####print(M)
```

## phyla level individual relative abundance bar graph


```{r chunk label, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=6}
knitr::opts_chunk$set(fig.width=15, fig.height=10, message=FALSE, warning=FALSE)
theme_set(theme_bw(base_size=25))
transform <- microbiome::transform
j <- transform(phy, "compositional")
sp <- aggregate_taxa(j, "phylum")
#today md <-  psmelt(sp)
#today op <- aggregate_rare(md, level = 'genus',detection = 0.1/100, prevalence = 20/100, include.lowest =TRUE)
#tax_table(sp$other) <- aggregate_rare(sp, level = 'genus',detection = 0.1/100, prevalence = 20/100, include.lowest =FALSE)
o <- aggregate_rare(sp, level = 'phylum',detection = 0.1/100, prevalence = 20/100, include.lowest =TRUE)
#@# md <-  psmelt(o)
phyla.ordering <- names(sort(rowMeans(abundances(transform(o, "compositional")))))
df <- psmelt(o)
df$Phylum <- factor(df$phylum, levels=phyla.ordering)
sorted.samples.by.Firmicutes <- unlist(subset(df, Phylum=="Firmicutes") %>% arrange(Abundance) %>% select(Sample))
df$Sample <- factor(df$Sample, levels = sorted.samples.by.Firmicutes)
w <- df %>% filter (Geographical_location=="Ahmednagar")
f <- ggplot(w, aes(x = Sample, fill = Phylum, y = Abundance)) + geom_bar(stat = "identity", colour = "black") + 
            labs(y =  "Relative abundance (%)", x = "") + scale_y_continuous(label=scales::percent) + scale_fill_brewer("Phylum", palette = "Set3") + facet_grid(Geographical_location ~ .) + facet_grid(cols = vars(Geographical_location)) + theme(axis.text.x = element_blank(),legend.position = "none") 
print(f)


l <- df %>% filter (Geographical_location=="Pune")
m <- ggplot(l, aes(x = Sample, fill = Phylum, y = Abundance)) + geom_bar(stat = "identity", colour = "black") + 
            labs(y =  "", x = "") + scale_y_continuous(label=scales::percent)  + scale_fill_brewer("Phylum", palette = "Set3") + facet_grid(Geographical_location ~ .) +  facet_grid(cols = vars(Geographical_location)) + theme(axis.text.x = element_blank(), legend.position = "none")
print(m)

n <- df %>% filter (Geographical_location=="Nashik")
u <- ggplot(n, aes(x = Sample, fill = Phylum, y = Abundance)) + geom_bar(stat = "identity", colour = "black") + 
            labs(y =  "", x = "") + scale_y_continuous(label=scales::percent) + scale_fill_brewer("Phyla", palette = "Set3") + facet_grid(Geographical_location ~ .) + facet_grid(cols = vars(Geographical_location)) + theme(axis.text.x = element_blank())
print(u)

library("gridExtra")
grid.arrange(f, m, u , nrow = 1)
```



## Differential abundance analysis (with ANCOM)

In [jointanalysis.md](jointanalysis.md) it was shown that geographical location has a significant effect.

Here, we investigate individual taxonomic groups in more detail.

For community comparison, see [CSTAnalysis_SkinSamples.md](CSTAnalysis_SkinSamples.md)

Significant (or marginally significant) taxa between geographical locations.

```{r xyz, echo=FALSE, message=FALSE, warning=FALSE, fig.width=7, fig.height=5, out.width="25%", fig.show="hold"}
theme_set(theme_bw(base_size=25))
library(readr)
library(tidyverse)
otu_data <- abundances(phy)
meta_data <- meta(phy)
# To get this, clone
# https://github.com/FrederickHuangLin/ANCOM.git
library(compositions)
source("ANCOM/scripts/ancom_v2.1.R")
# Step 1: Data preprocessing
feature_table = otu_data;
sample_var = "Sample";
group_var = NULL
out_cut = 0.05;
zero_cut = 0.90;
lib_cut = 1000;
neg_lb = FALSE
prepro = feature_table_pre_process(feature_table,
                                   meta_data,
				   sample_var,
				   group_var, 
                                   out_cut,
				   zero_cut,
				   lib_cut,
				   neg_lb)
feature_table = prepro$feature_table # Preprocessed feature table
meta_data = prepro$meta_data # Preprocessed metadata
struc_zero = prepro$structure_zeros # Structural zero info
# Step 2: ANCOM
main_var <- "Geographical_location";
p_adj_method <- "BH";
alpha <- 0.05
adj_formula <- NULL;
rand_formula <- NULL
res <- ANCOM(feature_table, meta_data, struc_zero,
             main_var, p_adj_method, 
             alpha, adj_formula, rand_formula)
res.sorted <- res$out %>% arrange(desc(W))
top.taxa <- res.sorted[which(res.sorted[,3]), "taxa_id"]
head(res.sorted)
ps <- microbiome::transform(phy, "compositional")
d <- meta(ps)
library(beeswarm)
for (tax in top.taxa) {
  d$taxa <- abundances(ps)[tax, ]
  # Add small pseudocount to enable visualization
  d$taxa <- d$taxa + min(abundances(ps)[abundances(ps)>0])/2
  
  # d$gen <- taxa(ps)["genus", ]
 
p <- ggplot(d, aes(x = Geographical_location, y = taxa)) +
    geom_boxplot() + 
    ggbeeswarm::geom_beeswarm() +
    scale_y_continuous() +
    #scale_y_continuous(limits = c(0.005,0.005, 0.01,0.1, 0.5, 1.0)) +
    theme(axis.text.x = element_text(angle = 360, hjust = 1)) +
    #labs(x = "Location", y = "Abundance (CLR)", title = map_levels(tax, from='tax', to='genus',ps))
    labs(x = "Location", y = "Abundance (%)", title = as.vector(tax_table(ps)[tax, "genus"]))
  print(p)
}
```

## Dunn test for pairwise comparisions

```{r dunn, echo=FALSE, message=FALSE, warning=FALSE}
library(FSA)
ps <- microbiome::transform(phy, "compositional")
# CLR transform
#o <- microbiome::transform(phy, "clr")
d <- meta(ps)
#p_adj_method <- "fdr"
for (tax in top.taxa) {
  d$taxa <- abundances(ps)[tax, ]
  # Add small pseudocount to enable visualization
  d$taxa <- d$taxa + min(abundances(ps)[abundances(ps)>0])/2
}
d1 <- data.frame(d)
re <- dunnTest(d1$taxa ~ d1$Geographical_location,data=d1)
print(re)
```


```{r renuschunk, echo=FALSE, message=FALSE, warning=FALSE}
s1 <- sample_names(subset_samples(ps, Geographical_location == "Ahmednagar"))
s2 <- sample_names(subset_samples(ps, Geographical_location == "Nashik"))
s3 <- sample_names(subset_samples(ps, Geographical_location == "Pune"))
rp<- rowMeans(abundances(pseq)[, s1])/rowMeans(abundances(pseq)[, s2])/rowMeans(abundances(pseq)[, s3])
#sample_data(ps)$rp<- rowMeans(abundances(pseq)[, s1])/rowMeans(abundances(pseq)[, s2])/rowMeans(abundances(pseq)[, s3])
```


## Differential abundance analysis (with ANCOM-BC)

```{r ANCOM-BC, echo=FALSE, message=FALSE, warning=FALSE}
#library(tidyverse)
#library(microbiome)
#library(magrittr)
#library(qwraps2)
#library(ANCOMBC)
#library(DT)
#options(DT.options = list(
#  initComplete = JS("function(settings, json) {",
#  "$(this.api().table().header()).css({'background-color': 
 # '#000', 'color': '#fff'});","}")))

#data= phy #<- readRDS("data/processed/phyloseq/phy20.1.RDS")

# Re-code the Geographical location group
#sample_data(data)$Geographical_location = recode(sample_data(data)$Geographical_location,
 #                                 Ahmednagar = "AN",
#                                  Nashik = "NS",
#                                  Pune = "PN")
# Re-code the age group
#sample_data(data)$age_group = recode(sample_data(data)$age_group,
#                                  middle_age = "MA",
#                                  elderly = "EL",
#                                  adult = "AD")

# Aggregate to gunus level
#genus_data = aggregate_taxa(data, "genus") 

# data summery
#options(qwraps2_markup = "markdown")
#summary_template =
 # list("Geographical_location" =
  #       list("Ahmednagar" = ~ n_perc0(Geographical_location == "AN", na_rm = TRUE),
#              "Nashik" = ~ n_perc0(Geographical_location == "NS", na_rm = TRUE),
#              "Pune" = ~ n_perc0(Geographical_location == "PN", na_rm = TRUE))) 
# "Age"= list("middle_age" = ~ n_perc0(age_group == "MA", na_rm = TRUE),
#             "elderly" = ~ n_perc0(age_group == "EL", na_rm = TRUE),
#            "adult" = ~ n_perc0(age_group == "AD", na_rm = TRUE))

#data_summary = summary_table(meta(data), summary_template)
#data_summary


# Running ANCOM-BC function

#out = ancombc(phyloseq = genus_data, formula = "Age", 
#              p_adj_method = "holm", zero_cut = 0.90, lib_cut = 1000, 
#              group = "Geographical_location", struc_zero = TRUE, neg_lb = TRUE, tol = 1e-5, 
 #             max_iter = 100, conserve = TRUE, alpha = 0.05, global = TRUE)

#res = out$res
#res_global = out$res_global

# coefficients 
#tab_coef = res$beta
#col_name = c("AN-NS", "AN-PN", "PN-NS")
#colnames(tab_coef) = col_name
#tab_coef %>% datatable(caption = "Coefficients from the Primary Result") %>%
#      formatRound(col_name, digits = 2)
```
