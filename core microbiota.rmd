---
title: "core microbiota"
author: "Renuka"
date: "11 February 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
``library(knitr)
require(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)

core_detection <- .1/100
core_prevalence <- 50/100


phy<-phyloseqsp

*core phyla*
ps <- aggregate_taxa(phy, "Phylum")
ps <- microbiome::transform(ps, "compositional")
(100 * rowMeans(abundances(ps.core)), 1)
prev <- round(100 * prevalence(ps.core <- core(ps, detection = core_detection, prevalence = core_prevalence)
m <- roundps.core, detection = core_detection), 1)
d <- as.data.frame(list(Taxon = names(m), Abundance = m, Prevalence = prev))
rownames(d) <- NULL
d <- d %>% arrange(desc(Abundance), desc(Prevalence))
colnames(d) <- c("Taxon", "Relative abundance (%)", "Prevalence (%)")
kable(d)



```{r Core, echo=F, fig.width=6, fig.height=4, fig.show="hold"}
print(p1)
`


```

*Core with varying detection and prevalence thresholds*

```{r core_heatmap, echo=FALSE, message=FALSE}
theme_set(theme_bw(base_size = 7))
library(RColorBrewer)
prevalences <- seq(.05, 1, .05)
detections <- 10^seq(log10(1e-3), log10(.2), length = 10)
ps <- microbiome::transform(ps, "compositional")

p1 <- plot_core(ps, plot.type = "heatmap", 
                prevalences = prevalences,
                detections = detections,
                colours = rev(brewer.pal(11, "Spectral")),
                min.prevalence = .2, horizontal = FALSE)

```

*Abundance variation across samples for each core taxa.

```{r core_rank_abundance, echo=FALSE, message=FALSE, fig.width=6, fig.height=4, fig.show="hold"}
theme_set(theme_bw(base_size = 10))
dfm <- melt(abundances(ps.core))
dfm$Var1 <- factor(dfm$Var1, levels = rev(d$Taxon))

dfm$Var_new = str_wrap(dfm$Var1, width = 40)

p2 <- ggplot(dfm, aes(x = Var_new, y = value, color = 'pink')) +
  geom_boxplot() +
  scale_y_log10(label = scales::percent) +
  coord_flip() + theme(legend.position="none") +
  labs(y = "Relative abundance (%)", x = 'Taxa', title = "Core abundance variation")
print(p2)





