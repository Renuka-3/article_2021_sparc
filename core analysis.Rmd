---
title: "core analysis"
author: "Renuka"
date: "2/10/2020"
output: html_document
---


```{r core, message=F, echo=FALSE}
library(knitr)
require(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)

core_detection <- .1/100
core_prevalence <- 50/100

phy<-oridffinlUnr

```



# Core microbiota.

Core microbiota is here defined based on the following parameters:

  * Detection threshold (relative abundance): `r 100 * core_detection`%
  * Prevalence threshold (above threshold in the population) `r 100 * core_prevalence`%.

The following taxonomic groups are in the core microbiota. Mean relative abundance and population prevalence (above detection threshold) are shown.

Core phyla.

```{r core_phyla, echo=FALSE, message=FALSE, fig.width=10, fig.height=8, out.width="50%"}

ps <- aggregate_taxa(phy, "genus")
ps <- microbiome::transform(ps, "compositional")
ps.core <- core(ps, detection = core_detection, prevalence = core_prevalence)
m <- round(100 * rowMeans(abundances(ps.core)), 1)
prev <- round(100 * prevalence(ps.core, detection = core_detection), 1)
d <- as.data.frame(list(Taxon = names(m), Abundance = m, Prevalence = prev))
rownames(d) <- NULL
d <- d %>% arrange(desc(Abundance), desc(Prevalence))
colnames(d) <- c("Taxon", "Relative abundance (%)", "Prevalence (%)")
kable(d)
```
Abundance variation across samples for each core taxa.

```{r core_rank_abundance, echo=FALSE, message=FALSE, fig.width=6, fig.height=4, fig.show="hold"}
theme_set(theme_bw(base_size = 10))
dfm <- melt(abundances(ps.core))
dfm$Var1 <- factor(dfm$Var1, levels = rev(d$Taxon))

dfm$Var_new = str_wrap(dfm$Var1, width = 40)

p2 <- ggplot(dfm, aes(x = Var_new, y = value, color = 'pink')) +
       geom_boxplot() +
       scale_y_log10(label = scales::percent) +
       coord_flip() + theme(legend.position="none") +
       labs(y = "Relative abundance (%)", x = 'Taxa', title = "Core abundance variation")
print(p2)
```


Core with varying detection and prevalence thresholds.

```{r core_heatmap, echo=FALSE, message=FALSE}
theme_set(theme_bw(base_size = 7))
library(RColorBrewer)
prevalences <- seq(.05, 1, .05)
detections <- 10^seq(log10(1e-3), log10(.2), length = 10)
ps <- microbiome::transform(ps, "compositional")

p1 <- plot_core(ps, plot.type = "heatmap", 
             prevalences = prevalences,
             detections = detections,
         colours = rev(brewer.pal(11, "Spectral")),
         min.prevalence = .2, horizontal = FALSE)
print(p1)

```

