row.names(otu_mat) <- otu_mat$OTUU
otu_mat <- otu_mat %>% select (-OTUU)
row.names(tax_mat) <- tax_mat$OTUU
tax_mat <- tax_mat %>% select (-OTUU)
row.names(samples_df) <- samples_df$Sample
#samples_df <- samples_df %>% select (-Sample)
otu_mat <- as.matrix(otu_mat)
tax_mat <- as.matrix(tax_mat)
OTU = otu_table(otu_mat, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
sam = sample_data(as.data.frame(samples_df))
phy20.1 <- phyloseq(OTU, TAX, sam)
saveRDS(phy20.1, file = "data/processed/phyloseq/phy20.1.RDS")
saveRDS(phy20.1, file = "data/processed/phyloseq/phy20.1.RDS")
phy20.1
otu_mat    <- as.data.frame(read_excel("data/processed/original_tables/otu.xlsx"))
tax_mat    <- as.data.frame(read_excel("data/processed/original_tables/taxa.xlsx"))
samples_df <- as.data.frame(read_excel("data/processed/original_tables/meta.xlsx"))
row.names(otu_mat) <- otu_mat$OTUU
otu_mat <- otu_mat %>% select (-OTUU)
row.names(tax_mat) <- tax_mat$OTUU
tax_mat <- tax_mat %>% select (-OTUU)
row.names(samples_df) <- samples_df$Sample
#samples_df <- samples_df %>% select (-Sample)
otu_mat <- as.matrix(otu_mat)
tax_mat <- as.matrix(tax_mat)
OTU = otu_table(otu_mat, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
sam = sample_data(as.data.frame(samples_df))
phy20.1 <- phyloseq(OTU, TAX, sam)
saveRDS(phy20.1, file = "data/processed/phyloseq/phy20.1.RDS")
library(ggplot2)
library(phyloseq)
library(dada2)
library(readxl)
library(dplyr)
otu_mat    <- as.data.frame(read_excel("data/processed/original_tables/otu.xlsx"))
tax_mat    <- as.data.frame(read_excel("data/processed/original_tables/taxa.xlsx"))
samples_df <- as.data.frame(read_excel("data/processed/original_tables/meta.xlsx"))
row.names(otu_mat) <- otu_mat$OTUU
otu_mat <- otu_mat %>% select (-OTUU)
row.names(tax_mat) <- tax_mat$OTUU
tax_mat <- tax_mat %>% select (-OTUU)
row.names(samples_df) <- samples_df$Sample
#samples_df <- samples_df %>% select (-Sample)
otu_mat <- as.matrix(otu_mat)
tax_mat <- as.matrix(tax_mat)
OTU = otu_table(otu_mat, taxa_are_rows = TRUE)
TAX = tax_table(tax_mat)
sam = sample_data(as.data.frame(samples_df))
phy20.1 <- phyloseq(OTU, TAX, sam)
saveRDS(phy20.1, file = "data/processed/phyloseq/phy20.1.RDS")
library(knitr)
library(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
# Was created with: source("create_phyloseq.R")
phy20.1 <- readRDS("C:/Users/Admin/Documents/GitHub/skin_microbiome/data/processed/phyloseq/phy20.1.RDS")
library(microbiome)
opts_chunk$set(dev="CairoPNG")
# Estimate alpha diversities
A <- alpha(phy20.1)
index <- "diversity_shannon"
library(Cairo)
df <- meta(phy20.1)
df <- bind_cols(df, A)
df$index <- df[[index]]
pv <- kruskal.test(data = df, index ~ factor(Geographical_location))$p.value
library(ggbeeswarm)
p1 <- ggplot(df, aes(x = Geographical_location, y = index, fill = Geographical_location)) + ggbeeswarm::geom_beeswarm() + theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
labs(y = "Shannon Diversity", x = "", title = paste0("Kruskal test p=", round(pv, 2)))
print(p1)
#p2 <- ggplot(df, aes(fill = Geographical_location, x = index)) + geom_histogram(alpha = 0.5, position = "dodge") + labs(x = "Shannon Diversity", y = "Density")
#print(p2)
library(microbiome)
library(phyloseq)
library(vegan)
opts_chunk$set(dev="CairoPNG")
method <- "PCoA"
trans <- "compositional"
distance <- "jaccard"
theme_set(theme_bw(15))
library(microbiome)
p <- plot_landscape(microbiome::transform(phy20.1 , "compositional"),
distance = "jaccard",
method = "PCoA",
size = 3,
col = "Geographical_location",
shading = FALSE) +
scale_colour_brewer(palette = "Set1")
print(p)
library(phyloseq)
library(reshape2)
library(DESeq2)
padj.th <- 0.25
mypseq <- phy20.1
# Remove NAs
group <- "Geographical_location"
keep <- meta(phy20.1)[, group] %>% complete.cases()
df <- meta(mypseq)[keep, ]
mygroup <- "Geographical_location"
df$group <- as.factor(df[[group]] == mygroup)
sample_data(mypseq) <- sample_data(df)
quiet(ds2 <- phyloseq_to_deseq2(mypseq, ~ Geographical_location))
dds <- DESeq(ds2)
res <- results(dds)
df <- as.data.frame(res)
df$taxon <- rownames(df)
#df <- df %>% arrange(desc(abs(log2FoldChange)), padj) %>%
#             filter(padj < padj.th)
df <- df %>% arrange(padj, desc(abs(log2FoldChange))) %>%
filter(padj < padj.th)
df <- subset(df, select= c(log2FoldChange, padj, taxon))
rownames(df) <- NULL
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
top.taxa <- as.character(df$taxon)
library(knitr)
kable(df)
df <- meta(phy20.1)
ps <- microbiome::transform(phy20.1, "clr")
for (tax in top.taxa) {
df$taxa <- abundances(ps)[tax, ]
p <- ggplot(df, aes(x = Geographical_location, y = taxa)) +
geom_boxplot() +
ggbeeswarm::geom_beeswarm() +
theme(axis.text.x = element_text(angle = 360, hjust = 1)) +
labs(x = "Geographical location", y = "Abundance", title = tax)
print(p)
}
library(microbiome)
library(ggplot2)
library(dplyr)
pseq <- phy20.1# Rename the example data
data = microbiome::meta(phy20.1)
# Pick relative abundances (compositional) and sample metadata
pseq.rel <- microbiome::transform(pseq, "compositional")
otu <- abundances(pseq.rel)
meta <- meta(pseq.rel)
library(vegan)
library(phyloseq)
permanova <- adonis(t(otu) ~ Geographical_location,
data = meta(phy20.1), permutations=99, method = "bray")
# P-value
print(as.data.frame(permanova$aov.tab)["Geographical_location", "Pr(>F)"])
dist <- vegdist(t(otu))
anova(betadisper(dist, meta$Geographical_location))
library(vegan)
coef <- coefficients(permanova)["Geographical_location1", ]
top.coef <- coef[rev(order(abs(coef)))[1:20]]
par(mar = c(3, 14, 2, 1))
barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
#barplot(sort(coef(permanova)["Geographical_location1", ]))
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
library(knitr)
library(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
# Was created with: source("create_phyloseq.R")
phy20.1 <- readRDS("data/processed/phyloseq/phy20.1.RDS")
library(microbiome)
opts_chunk$set(dev="CairoPNG")
# Estimate alpha diversities
A <- alpha(phy20.1)
index <- "diversity_shannon"
library(Cairo)
df <- meta(phy20.1)
df <- bind_cols(df, A)
df$index <- df[[index]]
pv <- kruskal.test(data = df, index ~ factor(Geographical_location))$p.value
library(ggbeeswarm)
p1 <- ggplot(df, aes(x = Geographical_location, y = index, fill = Geographical_location)) + ggbeeswarm::geom_beeswarm() + theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
labs(y = "Shannon Diversity", x = "", title = paste0("Kruskal test p=", round(pv, 2)))
print(p1)
#p2 <- ggplot(df, aes(fill = Geographical_location, x = index)) + geom_histogram(alpha = 0.5, position = "dodge") + labs(x = "Shannon Diversity", y = "Density")
#print(p2)
library(microbiome)
library(phyloseq)
library(vegan)
opts_chunk$set(dev="CairoPNG")
method <- "PCoA"
trans <- "compositional"
distance <- "jaccard"
library(microbiome)
library(phyloseq)
library(vegan)
opts_chunk$set(dev="CairoPNG")
method <- "PCoA"
trans <- "compositional"
distance <- "jaccard"
theme_set(theme_bw(15))
library(microbiome)
p <- plot_landscape(microbiome::transform(phy20.1 , "compositional"),
distance = "jaccard",
method = "PCoA",
size = 3,
col = "Geographical_location",
shading = FALSE) +
scale_colour_brewer(palette = "Set1")
print(p)
library(phyloseq)
library(reshape2)
library(DESeq2)
padj.th <- 0.25
mypseq <- phy20.1
# Remove NAs
group <- "Geographical_location"
keep <- meta(phy20.1)[, group] %>% complete.cases()
df <- meta(mypseq)[keep, ]
mygroup <- "Geographical_location"
df$group <- as.factor(df[[group]] == mygroup)
sample_data(mypseq) <- sample_data(df)
quiet(ds2 <- phyloseq_to_deseq2(mypseq, ~ Geographical_location))
dds <- DESeq(ds2)
res <- results(dds)
df <- as.data.frame(res)
df$taxon <- rownames(df)
#df <- df %>% arrange(desc(abs(log2FoldChange)), padj) %>%
#             filter(padj < padj.th)
df <- df %>% arrange(padj, desc(abs(log2FoldChange))) %>%
filter(padj < padj.th)
df <- subset(df, select= c(log2FoldChange, padj, taxon))
rownames(df) <- NULL
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
top.taxa <- as.character(df$taxon)
library(knitr)
kable(df)
df <- meta(phy20.1)
ps <- microbiome::transform(phy20.1, "clr")
for (tax in top.taxa) {
df$taxa <- abundances(ps)[tax, ]
p <- ggplot(df, aes(x = Geographical_location, y = taxa)) +
geom_boxplot() +
ggbeeswarm::geom_beeswarm() +
theme(axis.text.x = element_text(angle = 360, hjust = 1)) +
labs(x = "Geographical location", y = "Abundance", title = tax)
print(p)
}
library(microbiome)
library(ggplot2)
library(dplyr)
pseq <- phy20.1# Rename the example data
data = microbiome::meta(phy20.1)
# Pick relative abundances (compositional) and sample metadata
pseq.rel <- microbiome::transform(pseq, "compositional")
otu <- abundances(pseq.rel)
meta <- meta(pseq.rel)
library(vegan)
library(phyloseq)
permanova <- adonis(t(otu) ~ Geographical_location,
data = meta(phy20.1), permutations=99, method = "bray")
# P-value
print(as.data.frame(permanova$aov.tab)["Geographical_location", "Pr(>F)"])
dist <- vegdist(t(otu))
anova(betadisper(dist, meta$Geographical_location))
library(vegan)
coef <- coefficients(permanova)["Geographical_location1", ]
top.coef <- coef[rev(order(abs(coef)))[1:20]]
par(mar = c(3, 14, 2, 1))
barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
#barplot(sort(coef(permanova)["Geographical_location1", ]))
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
knitr::knit("locationanalysis.Rmd")
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(phyloseq)
library(dada2)
library(readxl)
library(dplyr)
library(knitr)
library(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
# Was created with: source("create_phyloseq.R")
phy20.1 <- readRDS("data/phy20.1.RDS")
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(phyloseq)
library(dada2)
library(readxl)
library(dplyr)
library(knitr)
library(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
library(dplyr)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
# Was created with: source("create_phyloseq.R")
phy20.1 <- readRDS("data/processed/phyloseq/phy20.1.RDS")
library(microbiome)
opts_chunk$set(dev="CairoPNG")
# Estimate alpha diversities
A <- alpha(phy20.1)
index <- "diversity_shannon"
library(microbiome)
opts_chunk$set(dev="CairoPNG")
# Estimate alpha diversities
A <- alpha(phy20.1)
index <- "diversity_shannon"
library(Cairo)
df <- meta(phy20.1)
df <- bind_cols(df, A)
df$index <- df[[index]]
pv <- wilcox.test(data = df, index ~ factor(Diet))$p.value
library(ggbeeswarm)
p1 <- ggplot(df, aes(x = Diet, y = index, fill = Diet)) +
ggbeeswarm::geom_beeswarm() +
theme(axis.text.x = element_text(angle = 0, hjust = 1)) +
labs(y = "Shannon Diversity",
x = "",
title = paste0("Wilcoxon test p=", round(pv, 2)))
print(p1)
library(microbiome)
library(phyloseq)
library(vegan)
opts_chunk$set(dev="CairoPNG")
method <- "PCoA"
trans <- "compositional"
distance <- "jaccard"
theme_set(theme_bw(15))
library(microbiome)
p <- plot_landscape(microbiome::transform(phy20.1 , "compositional"),
distance = "jaccard",
method = "PCoA",
size = 3,
col = "Diet",
shading = FALSE) +
scale_colour_brewer(palette = "Set1")
print(p)
library(phyloseq)
library(reshape2)
library(DESeq2)
padj.th <- 0.25
mypseq <- phy20.1
# Remove NAs
group <- "Diet"
keep <- meta(phy20.1)[, group] %>% complete.cases()
df <- meta(mypseq)[keep, ]
mygroup <- "Diet"
df$group <- as.factor(df[[group]] == mygroup)
sample_data(mypseq) <- sample_data(df)
quiet(ds2 <- phyloseq_to_deseq2(mypseq, ~ Diet))
dds <- DESeq(ds2)
res <- results(dds)
df <- as.data.frame(res)
df$taxon <- rownames(df)
#df <- df %>% arrange(desc(abs(log2FoldChange)), padj) %>%
#             filter(padj < padj.th)
df <- df %>% arrange(padj, desc(abs(log2FoldChange))) %>%
filter(padj < padj.th)
df <- subset(df, select= c(log2FoldChange, padj, taxon))
rownames(df) <- NULL
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
top.taxa <- as.character(df$taxon)
library(knitr)
kable(df)
df <- meta(phy20.1)
ps <- microbiome::transform(phy20.1, "clr")
for (tax in top.taxa) {
df$taxa <- abundances(ps)[tax, ]
p <- ggplot(df, aes(x = Diet, y = taxa)) +
geom_boxplot() +
ggbeeswarm::geom_beeswarm() +
theme(axis.text.x = element_text(angle = 360, hjust = 1)) +
labs(x = "Diet", y = "Abundance", title = tax)
print(p)
}
library(microbiome)
library(ggplot2)
library(dplyr)
pseq <- phy20.1# Rename the example data
data = microbiome::meta(phy20.1)
# Pick relative abundances (compositional) and sample metadata
pseq.rel <- microbiome::transform(pseq, "compositional")
otu <- abundances(pseq.rel)
meta <- meta(pseq.rel)
library(vegan)
library(phyloseq)
permanova <- adonis(t(otu) ~ Diet,
data = meta(phy20.1), permutations=99, method = "bray")
# P-value
print(as.data.frame(permanova$aov.tab)["Diet", "Pr(>F)"])
dist <- vegdist(t(otu))
anova(betadisper(dist, meta$Diet))
library(vegan)
coef <- coefficients(permanova)["Diet1", ]
top.coef <- coef[rev(order(abs(coef)))[1:20]]
par(mar = c(3, 14, 2, 1))
barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
apply(tax_table(phy20.1), 1, function (x) {paste(x, collapse = "_")})
knitr::knit("dietanalysis.Rmd")
library(knitr)
require(knitcitations)
library(microbiome)
library(phyloseq)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(dada2)
theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
core_detection <- .1/100
core_prevalence <- 50/100
# Was created with: source("create_phyloseq.R")
phy20.1 <- readRDS("data/processed/phyloseq/phy20.1.RDS")
ps <- aggregate_taxa(phy20.1, "genus")
ps <- microbiome::transform(ps, "compositional")
ps.core <- core(ps, detection = core_detection, prevalence = core_prevalence)
m <- round(100 * rowMeans(abundances(ps.core)), 1)
prev <- round(100 * prevalence(ps.core, detection = core_detection), 1)
d <- as.data.frame(list(Taxon = names(m), Abundance = m, Prevalence = prev))
rownames(d) <- NULL
d <- d %>% arrange(desc(Abundance), desc(Prevalence))
colnames(d) <- c("Taxon", "Relative abundance (%)", "Prevalence (%)")
kable(d)
theme_set(theme_bw(base_size = 13))
dfm <- melt(abundances(ps.core))
dfm$Var1 <- factor(dfm$Var1, levels = rev(d$Taxon))
dfm$Var_new = str_wrap(dfm$Var1, width = 40)
p2 <- ggplot(dfm, aes(x = Var_new, y = value, color = 'pink')) +
geom_boxplot() +
scale_y_log10(label = scales::percent) +
coord_flip() + theme(legend.position="none") +
labs(y = "Relative abundance (%)", x = 'Taxa', title = "Core abundance variation")
print(p2)
theme_set(theme_bw(base_size = 11))
library(RColorBrewer)
prevalences <- seq(.05, 1, .05)
detections <- 10^seq(log10(1e-3), log10(.2), length = 10)
ps <- microbiome::transform(ps, "compositional")
p1 <- plot_core(ps, plot.type = "heatmap",
prevalences = prevalences,
detections = detections,
colours = rev(brewer.pal(11, "Spectral")),
min.prevalence = .2, horizontal = FALSE)
print(p1)
library(reshape2)
a <- aggregate_taxa(phy20.1, level = "phylum")
xc <- abundances(transform(a, "compositional"))
dfm <- melt(xc)
names(dfm) <- c("phylum", "sample", "value")
dfm$Phylum <- factor(dfm$phylum,
levels = as.character(unlist(dfm %>% group_by(phylum) %>%
summarise(mean = mean(value)) %>%
arrange(desc(mean)) %>%
select(phylum))))
# Add small constant on zero values
dfm$value[dfm$value == 0] <- min(dfm$value[dfm$value > 0])/2
# Plot abundance distribution for the phyla
p <- ggplot(dfm, aes(x = value, fill = Phylum)) +
geom_density(alpha = 0.5) +
scale_x_log10(label = scales::percent) +
labs(x = "Relative abundance (%)", y = "Frequency",
title = "Phylum abundance distribution")
print(p)
library(reshape2)
a <- aggregate_taxa(phy20.1, level = "phylum")
xc <- abundances(transform(a, "compositional"))
dfm <- melt(xc)
names(dfm) <- c("phylum", "sample", "value")
dfm$Phylum <- factor(dfm$phylum,
levels = as.character(unlist(dfm %>% group_by(phylum) %>%
summarise(mean = mean(value)) %>%
arrange(desc(mean)) %>%
select(phylum))))
# Add small constant on zero values
dfm$value[dfm$value == 0] <- min(dfm$value[dfm$value > 0])/2
# Plot abundance distribution for the phyla
p <- ggplot(dfm, aes(x = value, fill = phylum)) +
geom_density(alpha = 0.5) +
scale_x_log10(label = scales::percent) +
labs(x = "Relative abundance (%)", y = "Frequency",
title = "Phylum abundance distribution")
print(p)
library(knitr)
a <- aggregate_taxa(phy20.1, level = "phylum")
xc <- abundances(transform(a, "compositional"))
df <- melt(xc)
names(df) <- c("phylum", "sample", "value")
dfm <- df %>% group_by(phylum) %>%
summarise(mean = round(100 * mean(value), 1),
median = round(100 * median(value), 1),
min = round(100 * min(value), 1),
max = round(100 * max(value), 1)) %>%
arrange(desc(mean))
kable(dfm)
knitr::knit("coreanalysis.Rmd")
