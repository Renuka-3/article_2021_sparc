---
title: "Dirichlet multinominal analysis"
author: "Renuka"
date: "`r Sys.Date()`"
output: html_document
---



```{r init, echo=FALSE, message=FALSE, warning=FALSE}
library(microbiome)
library(DirichletMultinomial)
library(reshape2)
library(magrittr)
library(dplyr)
library(knitr)
phy <- readRDS("data/processed/phyloseq/phy20.1.RDS")
# data(phy) -> this was to load other example data; not needed as you just loaded phy above
pseq <- phy

# Include only those groups that exceed certain abundance and prevalenec
set.seed(455423)
pseq.comp <- microbiome::transform(pseq, "compositional")

theme_set(theme_bw(20))
knitr::opts_chunk$set(fig.width=10, fig.height=10, message=FALSE, warning=FALSE)
opts_chunk$set(dev="CairoPNG")

# Set this to make sure that the figures of this Rmd file get their own name
knitr::opts_chunk$set(fig.path="figure_DMM/")

det.th <- 0/100
prev.th <- 10/100
taxa <- core_members(pseq.comp, detection = det.th, prevalence = prev.th)
pseq <- prune_taxa(taxa, pseq)

dat <- abundances(pseq)
count <- as.matrix(t(dat))
```

Altogether `r length(taxa)` taxonomic groups are detected with `r 100 * prev.th`% prevalence at `r 100 * det.th`% relative abundance. We used this set to determine the community types.




```{r nclusters, echo=FALSE, message=FALSE, warning=FALSE}
# Define here the max (possible) number of clusters. The higher it is, the slower the computing.
max.clusters <- 5
quiet(fit <- lapply(1:max.clusters, dmn, count = count, verbose=TRUE))

lplc <- sapply(fit, laplace) 
aic  <- sapply(fit, AIC) 
bic  <- sapply(fit, BIC)

best <- fit[[which.min(unlist(lplc))]]
# mixturewt(best)
```

The optimal number of clusters is: `r which.min(unlist(lplc))`

The (main) drivers per component are visualized.

```{r DMM, out.width="100%", echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold", fig.width=20, fig.height=10}
library(dplyr)
ass <- apply(mixture(best), 1, which.max)

full.names <- apply(tax_table(phy), 1, function (x) {paste(x, collapse = "_")})

dd <- melt(fitted(best))
colnames(dd) <- c("OTU", "cluster", "value")
# Add full names
dd$full_name <- gsub("Bacteria_", "", full.names[dd$OTU])
ncomp <- ncol(fitted(best))
#x <- full.names %>% strsplit("_" ) %>% sapply(tail, 1 )   
#r <- c("my_test_string", "and_another_one") %>% strsplit("_" ) %>% sapply(tail, 1 )  
#x <- some.manipulation(df$old); df$new <- x

dd$short_name <- dd$full_name %>% strsplit("_" ) %>% sapply(tail, 1 )
#dd$short_name <- x


for (k in seq(ncomp)) {

  d <- subset(dd, cluster == k) %>%
    # Only show the most important drivers (top 5 percent)
    filter(abs(value) > quantile(abs(value), 1 - 0.05)) %>%
    # Arrange OTUs by assignment strength    
    arrange(value) %>%
    mutate(OTU = factor(OTU, levels = unique(OTU))) %>%
    #mutate(short_name = factor(r, levels = unique(r))) 
    mutate(short_name = factor(short_name, levels = unique(short_name)))
    
  p <- ggplot(d, aes(x = short_name, y = value)) +
    geom_bar(stat = "identity") +
    coord_flip() +    
    labs(x= "", title = paste("Top drivers: community type", k))

  print(p)

}  
```





## Principal Coordinates Analysis (PCoA)

Coloured by DMM community type.


```{r pcoa, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="33%", fig.show="hold", warning=FALSE}
#theme_set(theme_bw(15))
method <- "PCoA"
trans <- "compositional"
distance <- "bray"
sample_data(phy)$community_type <- factor(ass[rownames(sample_data(phy))])
p <- plot_landscape(microbiome::transform(phy , "compositional"),
                    distance = distance,
                    method = method,
                    size = 3,
                    col = "community_type",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p)
```

* Ordination method: `r method`
* Dissimilarity measure: `r distance`
