---
title: "joint analysis"
author: "Renuka"
date: "24 October 2020"
output: html_document
---


# Ordination

```{r init, echo=FALSE, message=FALSE}
library(microbiome)
library(phyloseq)
library(vegan)
library(Cairo)
library(knitr)
library(knitcitations)
library(microbiome)
library(ggplot2)
library(dplyr)
library(vegan)
library(phyloseq)
library(microbiome)
library(phyloseq)
library(reshape2)
library(DESeq2)


opts_chunk$set(dev="CairoPNG")
knitr::opts_chunk$set(fig.path="figure_joint/")

method <- "PCoA"
trans <- "compositional"
distance <- "jaccard"
phy <- readRDS("data/processed/phyloseq/phy20.1.RDS")
```

## *Principal Coordinates Analysis (PCoA)*

* Ordination method: `r method`
* Dissimilarity measure: `r distance`

```{r pcoa, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="50%", fig.show="hold", warning=FALSE}
theme_set(theme_bw(15))
p <- plot_landscape(microbiome::transform(phy , "compositional"),
                    distance = "jaccard",
                    method = "PCoA",
                    size = 3,
                    col = "Diet",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p)

p1 <- plot_landscape(microbiome::transform(phy , "compositional"),
                    distance = "jaccard",
                    method = "PCoA",
                    size = 3,
                    col = "Geographical_location",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p1)

p2 <- plot_landscape(microbiome::transform(phy , "compositional"),
                     distance = "jaccard",
                     method = "PCoA",
                     size = 3,
                     col = "age_group",
                     shading = FALSE) +
  scale_colour_brewer(palette = "Set1")		    
print(p2)
```

# PERMANOVA analysis

```{r PERMANOVA, message=FALSE}
res <- adonis(t(otu_table(phy)) ~ Diet + Geographical_location + age_group,
         data = meta(phy),
	 permutations=99,
	 method = "bray")
print(res)
```

# Differential abundance analysis

```{r DESeq2, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width="50%", fig.show="hold"}
location <- meta(phy)$Geographical_location
A <- abundances(phy);
pv <- apply(A, 1, function (x) {kruskal.test(x ~ location)$p.value});
padj <- p.adjust(pv);

df <- data.frame(taxon = names(padj), padj = padj)
# Add full names for the taxa
full.names <- apply(tax_table(phy), 1, function (x) {paste(x, collapse = "_")})
df$full_name <- full.names[df$taxon]
df <- df %>% filter(padj < 0.25) %>% arrange(padj)
rownames(df) <- NULL

library(knitr)
kable(df)
```

