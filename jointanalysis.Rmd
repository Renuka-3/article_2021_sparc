
# Ordination

```{r init, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
library(microbiome)
library(phyloseq)
library(vegan)
library(Cairo)
library(knitr)
library(knitcitations)
library(microbiome)
library(ggplot2)
library(dplyr)
library(vegan)
library(phyloseq)
library(microbiome)
library(phyloseq)
library(reshape2)


opts_chunk$set(dev="CairoPNG")
knitr::opts_chunk$set(fig.path="figure_joint/")

method <- "PCoA"
trans <- "compositional"
distance <- "bray"
phy <- readRDS("data/processed/phyloseq/phy20.1.RDS")
```

## *Principal Coordinates Analysis (PCoA)*

* Ordination method: `r method`
* Dissimilarity measure: `r distance`

```{r pcoa, echo=FALSE, message=FALSE, fig.width=20, fig.height=15, out.width="40", fig.show="hold", warning=FALSE}
theme_set(theme_bw(50))
phy.temp <- phy
sample_data(phy.temp)$Diet <- as.factor(gsub("Veg", "Vegetarian", sample_data(phy.temp)$Diet))
p <- plot_landscape(microbiome::transform(phy.temp , "compositional"),
                    distance = distance,
                    method = method,
                    size = 5,
                    col = "Diet",
                    shading = FALSE) +
  scale_colour_brewer(palette = "Set1")	+ labs(title = "Diet") + theme(legend.position = 'bottom', legend.text=element_text(size=32)) + theme(legend.title=element_blank()) 
print(p)

theme_set(theme_bw(50))
phy.tempp <- phy
sample_data(phy.tempp)$age_group <- as.factor(gsub("middle_age", "Middle age", sample_data(phy.temp)$age_group))
sample_data(phy.tempp)$age_group<- as.factor(gsub("adult", "Adult", sample_data(phy.tempp)$age_group))
sample_data(phy.tempp)$age_group<- as.factor(gsub("elderly", "Elderly", sample_data(phy.tempp)$age_group))
p1<- plot_landscape(microbiome::transform(phy.tempp , "compositional"),
                     distance = distance,
                     method = method,
                     size = 5,
                     col = "age_group",
                     shading = FALSE) +
  scale_colour_brewer(palette = "Set1")	+ labs(title = "Age group")+ theme(legend.position = 'bottom', legend.text=element_text(size=32))+ theme(legend.title=element_blank())    
print(p1)

#p2<- plot_landscape(microbiome::transform(phy , "compositional"),
                    #distance = distance,
                    #method = method,
                    #size = 5,
                    #col = "Geographical_location",
                    #shading = FALSE) +
  #scale_colour_brewer(palette = "Set1") + labs(title = "Geographical location") + theme(legend.position = 'bottom', legend.text=element_text(size=12), legend.title=element_text(size=22)) 
#print(p2)
#png("pcoa.png", width = 500, height = 500, res = 300)
gridExtra::grid.arrange(p, p1, nrow = 1)
#dev.off()
```

# PERMANOVA analysis

```{r PERMANOVA, echo=FALSE, message=FALSE, echo=F}
res <- adonis(t(otu_table(phy)) ~ Diet + Geographical_location + age_group,
         data = meta(phy),
	 permutations=99,
	 method = distance)
print(res)
```

# Conclusion

There is a significant difference in microbiota community composition between different geographical areas.

No significant effect is observed in diet or age group.

# Investigating the top factors

```{r,echo=FALSE, message=FALSE}
#coef <- coefficients(res)["Geographical_location1",]
#top.coef <- coef[rev(order(abs(coef)))[1:20]]
#par(mar = c(3, 14, 2, 1))
#barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
```



